<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KML to Google Earth via Drive - ·ûÉ·ûª·üÜ·ûï·üí·ûõ·ûº·ûú·ûò·û∂·ûü</title>
    <style>
        /* Your existing CSS styles - keep these */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(90deg, #1a73e8, #4CAF50);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
            padding: 25px;
        }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            h1 { font-size: 1.5em; }
        }
        
        /* Authentication Styles */
        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #d2e3fc;
            text-align: center;
        }
        .google-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        .google-btn:hover {
            background: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        .google-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #1a73e8;
        }
        .drive-status {
            background: #e8f5e9;
            border: 1px solid #4CAF50;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .drive-status.error {
            background: #ffebee;
            border-color: #f44336;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        .loading-overlay.show {
            display: flex;
        }
        
        /* Place Cards */
        .place-card {
            background: #f8f9fa;
            padding: 18px;
            margin: 12px 0;
            border-radius: 12px;
            border-left: 4px solid #4CAF50;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .place-card:hover {
            background: #e8f0fe;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }
        .place-card.selected {
            background: #e8f0fe;
            border-left-color: #1a73e8;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.2);
            transform: translateY(-2px);
        }
        .place-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 17px;
            margin-bottom: 8px;
        }
        
        /* Description Styles */
        .description-content {
            margin-top: 10px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .description-content.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .description-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        .description-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .description-header {
            font-weight: bold;
            color: #1a73e8;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .description-value {
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }
        .toggle-description {
            color: #1a73e8;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            padding: 5px 0;
            display: inline-block;
            margin-top: 5px;
        }
        
        /* Action Buttons */
        .action-btn {
            display: block;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: white;
            padding: 14px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.3);
            opacity: 0.95;
        }
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .action-btn.secondary {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }
        
        /* Other Elements */
        .info-box {
            background: #e8f0fe;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            border: 2px solid #d2e3fc;
        }
        .coordinate-box {
            background: #2c3e50;
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .search-box {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid #1a73e8;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        @media (max-width: 480px) {
            .btn-group { grid-template-columns: 1fr; }
        }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåç KML to Google Earth - ·ûÉ·ûª·üÜ·ûï·üí·ûõ·ûº·ûú·ûò·û∂·ûü</h1>
            <p>Automatically upload to Google Drive & open in Google Earth</p>
        </header>
        
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div style="width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p id="loadingText" style="margin-top: 20px; color: #666;">Loading...</p>
        </div>
        
        <div class="main-content">
            <!-- Sidebar -->
            <div>
                <!-- Authentication Section -->
                <div class="auth-section" id="authSection">
                    <div id="userInfo" style="display: none;">
                        <div class="user-info">
                            <img id="userAvatar" class="user-avatar" alt="User Avatar">
                            <div>
                                <div id="userName" style="font-weight: bold;"></div>
                                <div id="userEmail" style="font-size: 12px; color: #666;"></div>
                            </div>
                        </div>
                        <button onclick="signOut()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                            Sign Out
                        </button>
                    </div>
                    <button id="signInButton" class="google-btn" disabled>
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>
                
                <!-- Drive Status -->
                <div class="drive-status" id="driveStatus">
                    üîí Sign in to access Google Drive
                </div>
                
                <!-- Selected Location -->
                <div class="info-box" id="selected-box">
                    <h3>üìç Selected Location</h3>
                    <div id="selected-info">
                        <p style="color: #666;">Select a location from the list</p>
                    </div>
                    
                    <div id="selected-coords" class="hidden">
                        <div class="coordinate-box">
                            <div><strong>Latitude:</strong> <span id="coord-lat"></span></div>
                            <div><strong>Longitude:</strong> <span id="coord-lng"></span></div>
                            <div><strong>Altitude:</strong> <span id="coord-alt">0</span>m</div>
                        </div>
                        
                        <div class="btn-group">
                            <button class="action-btn" id="openEarthBtn" disabled>
                                üåç Open in Google Earth
                            </button>
                            <button class="action-btn secondary" id="openMapsBtn">
                                üó∫Ô∏è Open in Google Maps
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Instructions -->
                <div class="info-box">
                    <h3>üìã How It Works</h3>
                    <ol>
                        <li>Sign in with Google (required)</li>
                        <li>Select a location from the KML</li>
                        <li>System checks if KML exists in your Drive</li>
                        <li>If not found, uploads automatically</li>
                        <li>Opens in Google Earth with coordinates</li>
                    </ol>
                </div>
            </div>
            
            <!-- Main Content -->
            <div>
                <input type="text" id="searchInput" class="search-box" placeholder="üîç Search locations..." disabled>
                
                <div id="searchResults">
                    <div class="loading" id="loadingPlaces">
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p>Sign in to load KML data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === CONFIGURATION ===
        // REPLACE THESE WITH YOUR ACTUAL CREDENTIALS
        const CLIENT_ID = 'AIzaSyAS3pGiy7LRoPC2nAcT3iGBDF8rJHxDZgo'; // Replace with your Client ID
        const API_KEY = 'YOUR_API_KEY'; // Replace with your API Key
        
        // Your KML file URL
        const KML_GITHUB_URL = 'https://raw.githubusercontent.com/Gintra121/Search-Phlov-Meas/main/%E1%9E%83%E1%9F%86%E1%9E%9F%E1%9F%8B%E1%9E%9A%E1%9E%9B%E1%9E%8F%E1%9E%98%E1%9E%B8%E1%9E%9F%E1%9E%98%E1%9E%B6.kml';
        const KML_FILENAME = '·ûÉ·ûª·üÜ·ûï·üí·ûõ·ûº·ûú·ûò·û∂·ûü.kml';
        
        // Google API Scopes
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';
        
        // Global variables
        let allPlaces = [];
        let selectedPlace = null;
        let currentUser = null;
        let tokenClient = null;
        let gapiInited = false;
        let gisInited = false;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing application...');
            initializeGoogleApis();
            setupEventListeners();
        });
        
        // Initialize Google APIs
        function initializeGoogleApis() {
            // Load GAPI client library
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = function() {
                gapi.load('client', initializeGapiClient);
            };
            document.head.appendChild(gapiScript);
            
            // Load GIS (Google Identity Services) library
            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.onload = initializeGisClient;
            document.head.appendChild(gisScript);
        }
        
        // Initialize GAPI client
        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true;
                console.log('GAPI client initialized');
                maybeEnableButtons();
            } catch (error) {
                console.error('Error initializing GAPI:', error);
                showMessage('Error loading Google APIs', 'error');
            }
        }
        
        // Initialize GIS client
        function initializeGisClient() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Will be set dynamically
            });
            gisInited = true;
            console.log('GIS client initialized');
            maybeEnableButtons();
        }
        
        // Enable buttons when both APIs are loaded
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('signInButton').disabled = false;
                console.log('Google APIs loaded, sign-in button enabled');
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('signInButton').addEventListener('click', handleSignIn);
            document.getElementById('openEarthBtn').addEventListener('click', handleOpenEarth);
            document.getElementById('openMapsBtn').addEventListener('click', openGoogleMaps);
        }
        
        // Handle Google Sign In
        function handleSignIn() {
            if (!tokenClient) {
                showMessage('Google APIs not loaded yet', 'error');
                return;
            }
            
            tokenClient.callback = async (response) => {
                if (response.error !== undefined) {
                    console.error('OAuth error:', response);
                    showMessage('Sign-in failed. Please try again.', 'error');
                    return;
                }
                
                try {
                    // Get user info
                    await fetchUserInfo();
                    
                    // Load KML data
                    await loadKMLData();
                    
                    showMessage('Successfully signed in!', 'success');
                    
                } catch (error) {
                    console.error('Error after sign-in:', error);
                    showMessage('Error loading data after sign-in', 'error');
                }
            };
            
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        // Fetch user information
        async function fetchUserInfo() {
            try {
                showLoading('Loading user info...');
                
                const token = gapi.client.getToken();
                if (!token) {
                    throw new Error('No access token found');
                }
                
                // Get user profile
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${token.access_token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch user info');
                }
                
                const userData = await response.json();
                currentUser = userData;
                
                // Update UI
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userName').textContent = userData.name || 'Google User';
                document.getElementById('userEmail').textContent = userData.email || '';
                if (userData.picture) {
                    document.getElementById('userAvatar').src = userData.picture;
                }
                document.getElementById('signInButton').style.display = 'none';
                
                // Enable search
                document.getElementById('searchInput').disabled = false;
                
                // Update drive status
                document.getElementById('driveStatus').innerHTML = `
                    ‚úÖ Signed in as: ${userData.email}<br>
                    üìÅ Ready to access Google Drive
                `;
                document.getElementById('driveStatus').className = 'drive-status';
                
                hideLoading();
                
            } catch (error) {
                console.error('Error fetching user info:', error);
                hideLoading();
                showMessage('Failed to load user information', 'error');
            }
        }
        
        // Load KML data from GitHub
        async function loadKMLData() {
            try {
                showLoading('Loading KML data...');
                
                // Try to load from GitHub
                const response = await fetch(KML_GITHUB_URL);
                if (!response.ok) {
                    throw new Error('Failed to load KML from GitHub');
                }
                
                const kmlText = await response.text();
                parseKML(kmlText);
                
                hideLoading();
                showMessage(`Loaded ${allPlaces.length} locations`, 'success');
                
            } catch (error) {
                console.error('Error loading KML:', error);
                useSampleData();
                hideLoading();
                showMessage('Using sample data - KML loading failed', 'warning');
            }
        }
        
        // Parse KML data with structured descriptions
        function parseKML(kmlText) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
                const placemarks = xmlDoc.querySelectorAll('Placemark');
                
                allPlaces = [];
                
                placemarks.forEach((placemark, index) => {
                    // Extract name
                    const nameEl = placemark.querySelector('name');
                    const name = nameEl ? nameEl.textContent.trim() : `Location ${index + 1}`;
                    
                    // Extract coordinates
                    const coordEl = placemark.querySelector('coordinates');
                    let coordinates = null;
                    
                    if (coordEl) {
                        const coordText = coordEl.textContent.trim();
                        const parts = coordText.split(',');
                        if (parts.length >= 2) {
                            coordinates = {
                                longitude: parseFloat(parts[0]),
                                latitude: parseFloat(parts[1]),
                                altitude: parts.length >= 3 ? parseFloat(parts[2]) : 0
                            };
                        }
                    }
                    
                    // Extract and parse description
                    const descEl = placemark.querySelector('description');
                    const descriptionData = parseDescription(descEl ? descEl.innerHTML : '');
                    
                    allPlaces.push({
                        id: index + 1,
                        name: name,
                        description: descriptionData,
                        coordinates: coordinates,
                        hasCoordinates: coordinates !== null
                    });
                });
                
                renderPlaces(allPlaces);
                setupSearch();
                
            } catch (error) {
                console.error('Error parsing KML:', error);
                throw error;
            }
        }
        
        // Parse description into structured data
        function parseDescription(htmlContent) {
            try {
                if (!htmlContent.trim()) return [];
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const structuredData = [];
                
                // Try to find tables first (common in KML descriptions)
                const tables = doc.querySelectorAll('table');
                if (tables.length > 0) {
                    tables.forEach(table => {
                        const rows = table.querySelectorAll('tr');
                        rows.forEach(row => {
                            const cells = row.querySelectorAll('td, th');
                            if (cells.length >= 2) {
                                structuredData.push({
                                    type: 'keyvalue',
                                    key: cells[0].textContent.trim(),
                                    value: cells[1].textContent.trim()
                                });
                            } else if (cells.length === 1) {
                                const text = cells[0].textContent.trim();
                                if (text) {
                                    structuredData.push({
                                        type: 'header',
                                        text: text
                                    });
                                }
                            }
                        });
                    });
                }
                
                // If no tables found, try divs
                if (structuredData.length === 0) {
                    const elements = doc.querySelectorAll('div, p, span');
                    elements.forEach(el => {
                        const text = el.textContent.trim();
                        if (text) {
                            // Check if it looks like a header
                            const isHeader = el.tagName === 'B' || 
                                           el.tagName === 'STRONG' ||
                                           el.style.fontWeight === 'bold' ||
                                           text.includes(':') ||
                                           /^[A-Z][^:]*$/.test(text);
                            
                            if (isHeader) {
                                structuredData.push({
                                    type: 'header',
                                    text: text.replace(/:/g, '').trim()
                                });
                            } else {
                                // Try to split by colon for key-value pairs
                                const colonIndex = text.indexOf(':');
                                if (colonIndex > 0 && colonIndex < 50) {
                                    structuredData.push({
                                        type: 'keyvalue',
                                        key: text.substring(0, colonIndex).trim(),
                                        value: text.substring(colonIndex + 1).trim()
                                    });
                                } else {
                                    structuredData.push({
                                        type: 'text',
                                        text: text
                                    });
                                }
                            }
                        }
                    });
                }
                
                // If still no data, use plain text
                if (structuredData.length === 0) {
                    const plainText = htmlContent.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    if (plainText) {
                        structuredData.push({
                            type: 'text',
                            text: plainText
                        });
                    }
                }
                
                return structuredData;
                
            } catch (error) {
                console.error('Error parsing description:', error);
                const plainText = htmlContent.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                return plainText ? [{
                    type: 'text',
                    text: plainText
                }] : [];
            }
        }
        
        // Render places with structured descriptions
        function renderPlaces(places) {
            const container = document.getElementById('searchResults');
            const loadingEl = document.getElementById('loadingPlaces');
            
            if (loadingEl) {
                loadingEl.style.display = 'none';
            }
            
            if (places.length === 0) {
                container.innerHTML = '<div class="info-box">No locations found</div>';
                return;
            }
            
            let html = '';
            places.forEach(place => {
                const isSelected = selectedPlace && selectedPlace.id === place.id;
                const hasDescription = place.description && place.description.length > 0;
                
                // Generate preview text
                let previewText = '';
                if (hasDescription) {
                    const firstItem = place.description[0];
                    if (firstItem.type === 'keyvalue') {
                        previewText = `<strong>${escapeHtml(firstItem.key)}:</strong> ${escapeHtml(firstItem.value.substring(0, 80))}${firstItem.value.length > 80 ? '...' : ''}`;
                    } else if (firstItem.type === 'header') {
                        previewText = `<strong>${escapeHtml(firstItem.text)}</strong>`;
                    } else if (firstItem.type === 'text') {
                        previewText = escapeHtml(firstItem.text.substring(0, 100));
                        if (firstItem.text.length > 100) previewText += '...';
                    }
                }
                
                html += `
                    <div class="place-card ${isSelected ? 'selected' : ''}" 
                         onclick="selectPlace(${place.id})"
                         data-id="${place.id}">
                        <div class="place-name">${escapeHtml(place.name)}</div>
                        
                        ${previewText ? `
                            <div style="color: #666; font-size: 14px; margin: 8px 0;">
                                ${previewText}
                            </div>
                            <div class="description-content" id="desc-${place.id}">
                                ${renderStructuredDescription(place.description)}
                            </div>
                            <button class="toggle-description" onclick="toggleDescription(${place.id}, event)">
                                üìñ Show Details
                            </button>
                        ` : ''}
                        
                        ${place.hasCoordinates ? `
                            <div style="margin-top: 10px;">
                                <span style="background: #2c3e50; color: white; padding: 4px 10px; border-radius: 5px; font-size: 12px; font-family: monospace;">
                                    üìç ${place.coordinates.latitude.toFixed(6)}, ${place.coordinates.longitude.toFixed(6)}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Render structured description
        function renderStructuredDescription(descriptionData) {
            if (!descriptionData || descriptionData.length === 0) {
                return '<div style="color: #666; font-style: italic;">No description available</div>';
            }
            
            let html = '';
            descriptionData.forEach((item, index) => {
                if (item.type === 'header') {
                    html += `
                        <div class="description-item" style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <div class="description-header">${escapeHtml(item.text)}</div>
                        </div>
                    `;
                } else if (item.type === 'keyvalue') {
                    html += `
                        <div class="description-item">
                            <div class="description-header">${escapeHtml(item.key)}</div>
                            <div class="description-value">${escapeHtml(item.value)}</div>
                        </div>
                    `;
                } else if (item.type === 'text') {
                    html += `
                        <div class="description-item">
                            <div class="description-value">${escapeHtml(item.text)}</div>
                        </div>
                    `;
                }
            });
            
            return html;
        }
        
        // Toggle description visibility
        function toggleDescription(placeId, event) {
            event.stopPropagation();
            const descEl = document.getElementById(`desc-${placeId}`);
            const btn = event.target;
            
            if (descEl.classList.contains('show')) {
                descEl.classList.remove('show');
                btn.textContent = 'üìñ Show Details';
            } else {
                descEl.classList.add('show');
                btn.textContent = 'üìï Hide Details';
            }
        }
        
        // Select place
        function selectPlace(placeId) {
            document.querySelectorAll('.place-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            
            selectedPlace = allPlaces.find(p => p.id === placeId);
            
            if (selectedPlace) {
                const card = document.querySelector(`[data-id="${placeId}"]`);
                if (card) card.classList.add('selected');
                
                updateSelectedInfo();
                document.getElementById('openEarthBtn').disabled = false;
            }
        }
        
        // Update selected info
        function updateSelectedInfo() {
            const infoDiv = document.getElementById('selected-info');
            const coordsDiv = document.getElementById('selected-coords');
            
            if (!selectedPlace) {
                infoDiv.innerHTML = '<p style="color: #666;">Select a location from the list</p>';
                coordsDiv.classList.add('hidden');
                return;
            }
            
            infoDiv.innerHTML = `
                <h4 style="color: #1a73e8; margin-bottom: 10px;">${escapeHtml(selectedPlace.name)}</h4>
                <div style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;">
                    ${renderStructuredDescription(selectedPlace.description)}
                </div>
            `;
            
            if (selectedPlace.hasCoordinates) {
                document.getElementById('coord-lat').textContent = selectedPlace.coordinates.latitude.toFixed(6);
                document.getElementById('coord-lng').textContent = selectedPlace.coordinates.longitude.toFixed(6);
                document.getElementById('coord-alt').textContent = selectedPlace.coordinates.altitude;
                coordsDiv.classList.remove('hidden');
            }
        }
        
        // MAIN FUNCTION: Handle opening in Google Earth
        async function handleOpenEarth() {
            if (!selectedPlace || !currentUser) {
                showMessage('Please sign in and select a location', 'error');
                return;
            }
            
            try {
                showLoading('Checking Google Drive...');
                
                // 1. Check if KML exists in Drive
                const existingFile = await checkFileInDrive(KML_FILENAME);
                let fileId;
                
                if (existingFile) {
                    showMessage('KML found in your Drive', 'success');
                    fileId = existingFile.id;
                } else {
                    // 2. File doesn't exist - download and upload
                    showMessage('Uploading KML to your Drive...', 'info');
                    fileId = await uploadKmlToDrive();
                }
                
                // 3. Open file in Google Earth
                await openFileInEarth(fileId);
                
                // 4. Open Google Earth with coordinates
                openGoogleEarthWithCoordinates();
                
                hideLoading();
                showMessage('Opening in Google Earth...', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                hideLoading();
                showMessage('Error: ' + error.message, 'error');
            }
        }
        
        // Check if file exists in Google Drive
        async function checkFileInDrive(filename) {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${filename}' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                return response.result.files.length > 0 ? response.result.files[0] : null;
            } catch (error) {
                console.error('Error checking Drive:', error);
                throw new Error('Failed to access Google Drive');
            }
        }
        
        // Upload KML to Google Drive
        async function uploadKmlToDrive() {
            try {
                // Download KML from GitHub
                const response = await fetch(KML_GITHUB_URL);
                const kmlContent = await response.text();
                
                // Create metadata
                const metadata = {
                    name: KML_FILENAME,
                    mimeType: 'application/vnd.google-earth.kml+xml'
                };
                
                // Create form data
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' }));
                
                const token = gapi.client.getToken();
                
                // Upload to Drive
                const uploadResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token.access_token}`
                    },
                    body: form
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('Upload failed');
                }
                
                const result = await uploadResponse.json();
                return result.id;
                
            } catch (error) {
                console.error('Error uploading to Drive:', error);
                throw new Error('Failed to upload KML to Drive');
            }
        }
        
        // Open file in Google Earth
        async function openFileInEarth(fileId) {
            try {
                // Update permissions to make it readable by Google Earth
                await gapi.client.drive.permissions.create({
                    fileId: fileId,
                    resource: {
                        type: 'anyone',
                        role: 'reader'
                    }
                });
                
                // Construct Earth URL
                const earthUrl = `https://earth.google.com/earth/drive?state=%7B"ids"%3A%5B"${fileId}"%5D%2C"action"%3A"open"%7D&usp=drive_web`;
                
                // Open in new tab
                window.open(earthUrl, '_blank');
                
                return true;
            } catch (error) {
                console.error('Error opening in Earth:', error);
                throw new Error('Failed to open in Google Earth');
            }
        }
        
        // Open Google Earth with coordinates
        function openGoogleEarthWithCoordinates() {
            if (!selectedPlace || !selectedPlace.hasCoordinates) return;
            
            const lat = selectedPlace.coordinates.latitude;
            const lng = selectedPlace.coordinates.longitude;
            const name = encodeURIComponent(selectedPlace.name);
            
            // Open Earth with coordinates
            const earthUrl = `https://earth.google.com/web/search/${name}/@${lat},${lng},${selectedPlace.coordinates.altitude + 1000}a,1000d,35y,0h,0t,0r`;
            
            // Open in another tab
            setTimeout(() => {
                window.open(earthUrl, '_blank');
            }, 1000);
        }
        
        // Open Google Maps
        function openGoogleMaps() {
            if (!selectedPlace || !selectedPlace.hasCoordinates) {
                showMessage('Please select a location first', 'error');
                return;
            }
            
            const lat = selectedPlace.coordinates.latitude;
            const lng = selectedPlace.coordinates.longitude;
            const name = encodeURIComponent(selectedPlace.name);
            
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}&query_place_id=${name}`;
            window.open(mapsUrl, '_blank');
        }
        
        // Sign out
        function signOut() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    console.log('Token revoked');
                });
                gapi.client.setToken(null);
            }
            
            currentUser = null;
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('signInButton').style.display = 'block';
            document.getElementById('driveStatus').innerHTML = 'üîí Sign in to access Google Drive';
            document.getElementById('searchInput').disabled = true;
            document.getElementById('openEarthBtn').disabled = true;
            
            // Clear places
            allPlaces = [];
            selectedPlace = null;
            document.getElementById('searchResults').innerHTML = `
                <div class="loading" id="loadingPlaces">
                    <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p>Sign in to load KML data</p>
                </div>
            `;
            
            document.getElementById('selected-info').innerHTML = '<p style="color: #666;">Select a location from the list</p>';
            document.getElementById('selected-coords').classList.add('hidden');
            
            showMessage('Signed out successfully', 'success');
        }
        
        // Setup search
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (!query) {
                    renderPlaces(allPlaces);
                    return;
                }
                
                const filtered = allPlaces.filter(place => {
                    const searchText = place.name.toLowerCase() + ' ' + 
                                     JSON.stringify(place.description).toLowerCase();
                    return searchText.includes(query);
                });
                
                renderPlaces(filtered);
                
                // Clear selection if filtered out
                if (selectedPlace && !filtered.find(p => p.id === selectedPlace.id)) {
                    selectedPlace = null;
                    updateSelectedInfo();
                    document.getElementById('openEarthBtn').disabled = true;
                }
            });
        }
        
        // Use sample data if KML loading fails
        function useSampleData() {
            allPlaces = [
                {
                    id: 1,
                    name: "·ûÉ·ûª·üÜ·ûï·üí·ûõ·ûº·ûú·ûò·û∂·ûü - Sample 1",
                    description: [
                        { type: 'header', text: '·ûë·û∏·ûè·û∂·üÜ·ûÑ' },
                        { type: 'keyvalue', key: '·ûÅ·üÅ·ûè·üí·ûè', value: '·ûÄ·üÜ·ûñ·ûÑ·üã·ûü·üí·ûñ·û∫' },
                        { type: 'keyvalue', key: '·ûü·üí·ûö·ûª·ûÄ', value: '·û¢·ûé·üí·ûä·ûº·ûÑ·ûò·û∂·ûü' },
                        { type: 'keyvalue', key: '·ûÉ·ûª·üÜ', value: '·ûï·üí·ûõ·ûº·ûú·ûò·û∂·ûü' }
                    ],
                    coordinates: { latitude: 11.5564, longitude: 104.9282, altitude: 20 },
                    hasCoordinates: true
                },
                {
                    id: 2,
                    name: "·ûÉ·ûª·üÜ·ûï·üí·ûõ·ûº·ûú·ûò·û∂·ûü - Sample 2",
                    description: [
                        { type: 'header', text: '·ûñ·üê·ûè·üå·ûò·û∂·ûì·ûë·ûº·ûë·üÖ' },
                        { type: 'keyvalue', key: '·ûî·üí·ûö·ûá·û∂·ûá·ûì', value: '·ü¢·ü†,·ü†·ü†·ü† ·ûì·û∂·ûÄ·üã' },
                        { type: 'keyvalue', key: '·ûï·üí·ûë·üÉ·ûä·û∏', value: '·ü°·ü•·ü† ·ûÇ·ûò·ü¢' }
                    ],
                    coordinates: { latitude: 11.6000, longitude: 104.9500, altitude: 25 },
                    hasCoordinates: true
                }
            ];
            
            renderPlaces(allPlaces);
        }
        
        // Utility functions
        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }
        
        function showMessage(message, type = 'info') {
            // Create toast
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.style.position = 'fixed';
            toast.style.bottom = '30px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%) translateY(0)';
            toast.style.background = type === 'error' ? '#f44336' : 
                                   type === 'success' ? '#4CAF50' : '#2196F3';
            toast.style.color = 'white';
            toast.style.padding = '15px 25px';
            toast.style.borderRadius = '10px';
            toast.style.zIndex = '1000';
            toast.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
